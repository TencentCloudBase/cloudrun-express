# Express HTTP äº‘å‡½æ•°éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»å¦‚ä½•å°† Express åº”ç”¨éƒ¨ç½²åˆ° CloudBase HTTP äº‘å‡½æ•°ã€‚

## ğŸ“‹ ç›®å½•å¯¼èˆª

- [éƒ¨ç½²ç‰¹æ€§](#éƒ¨ç½²ç‰¹æ€§)
- [å‡†å¤‡éƒ¨ç½²æ–‡ä»¶](#å‡†å¤‡éƒ¨ç½²æ–‡ä»¶)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
- [è®¿é—®åº”ç”¨](#è®¿é—®åº”ç”¨)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## éƒ¨ç½²ç‰¹æ€§

HTTP äº‘å‡½æ•°é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š

- **è½»é‡çº§åº”ç”¨**ï¼šAPI æœåŠ¡ã€å¾®æœåŠ¡
- **é—´æ­‡æ€§è®¿é—®**ï¼šä¸éœ€è¦æŒç»­è¿è¡Œçš„åº”ç”¨
- **æˆæœ¬æ•æ„Ÿ**ï¼šæŒ‰è¯·æ±‚æ¬¡æ•°å’Œæ‰§è¡Œæ—¶é—´è®¡è´¹
- **å¿«é€Ÿéƒ¨ç½²**ï¼šæ— éœ€å®¹å™¨åŒ–é…ç½®

### æŠ€æœ¯ç‰¹ç‚¹

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **è®¡è´¹æ–¹å¼** | æŒ‰è¯·æ±‚æ¬¡æ•°å’Œæ‰§è¡Œæ—¶é—´ |
| **å¯åŠ¨æ–¹å¼** | å†·å¯åŠ¨ï¼ŒæŒ‰éœ€å¯åŠ¨ |
| **ç«¯å£è¦æ±‚** | å›ºå®š 9000 ç«¯å£ |
| **æ‰©ç¼©å®¹** | è‡ªåŠ¨æŒ‰è¯·æ±‚æ‰©ç¼© |
| **è¿è¡Œæ—¶** | Node.js 16.xã€18.xã€20.x |

## å‡†å¤‡éƒ¨ç½²æ–‡ä»¶

### 1. ä¿®æ”¹ç«¯å£é…ç½®

ç¼–è¾‘ `bin/www` æ–‡ä»¶ï¼Œç¡®ä¿äº‘å‡½æ•°ç¯å¢ƒä½¿ç”¨ 9000 ç«¯å£ï¼š

```javascript
/**
 * Get port from environment and store in Express.
 */

var port = normalizePort(process.env.PORT || '9000');
```

> âš ï¸ **é‡è¦æç¤º**ï¼šCloudBase HTTP äº‘å‡½æ•°è¦æ±‚åº”ç”¨ç›‘å¬ 9000 ç«¯å£ã€‚

### 2. åˆ›å»ºå¯åŠ¨è„šæœ¬

åˆ›å»º `scf_bootstrap` æ–‡ä»¶ï¼ˆæ— æ‰©å±•åï¼‰ï¼š

```bash
#!/bin/bash
export PORT=9000
npm start
```

ä¸ºå¯åŠ¨è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼š

```bash
chmod +x scf_bootstrap
```

### 3. ä¼˜åŒ– package.json

ç¡®ä¿ `package.json` åŒ…å«æ­£ç¡®çš„å¯åŠ¨è„šæœ¬ï¼š

```json
{
  "name": "cloudrun-express",
  "version": "1.0.0",
  "scripts": {
    "start": "node ./bin/www",
    "dev": "nodemon ./bin/www"
  },
  "dependencies": {
    "express": "^4.18.0",
    "morgan": "^1.10.0",
    "cookie-parser": "^1.4.6",
    "debug": "^4.3.4",
    "http-errors": "^2.0.0",
    "pug": "^3.0.2"
  }
}
```

## é¡¹ç›®ç»“æ„

```
cloudrun-express/
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ www                 # å¯åŠ¨æ–‡ä»¶
â”œâ”€â”€ public/                 # é™æ€èµ„æº
â”œâ”€â”€ routes/                 # è·¯ç”±æ–‡ä»¶
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ users.js
â”‚   â””â”€â”€ health.js
â”œâ”€â”€ views/                  # è§†å›¾æ¨¡æ¿
â”œâ”€â”€ app.js                  # åº”ç”¨ä¸»æ–‡ä»¶
â”œâ”€â”€ package.json           # é¡¹ç›®é…ç½®
â”œâ”€â”€ package-lock.json      # ä¾èµ–é”å®šæ–‡ä»¶
â””â”€â”€ scf_bootstrap         # ğŸ”‘ äº‘å‡½æ•°å¯åŠ¨è„šæœ¬
```

> ğŸ’¡ **è¯´æ˜**ï¼š
> - `scf_bootstrap` æ˜¯ CloudBase äº‘å‡½æ•°çš„å¯åŠ¨è„šæœ¬
> - è®¾ç½® `PORT=9000` ç¯å¢ƒå˜é‡ç¡®ä¿åº”ç”¨ç›‘å¬æ­£ç¡®ç«¯å£
> - ä½¿ç”¨ `npm start` å¯åŠ¨åº”ç”¨
> - äº‘å‡½æ•°ä¼šè‡ªåŠ¨å®‰è£… `package.json` ä¸­çš„ä¾èµ–

## éƒ¨ç½²æ­¥éª¤

### é€šè¿‡æ§åˆ¶å°éƒ¨ç½²

1. ç™»å½• [CloudBase æ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
2. é€‰æ‹©æ‚¨çš„ç¯å¢ƒï¼Œè¿›å…¥ã€Œäº‘å‡½æ•°ã€é¡µé¢
3. ç‚¹å‡»ã€Œæ–°å»ºäº‘å‡½æ•°ã€
4. é€‰æ‹©ã€ŒHTTP äº‘å‡½æ•°ã€
5. å¡«å†™å‡½æ•°åç§°ï¼ˆå¦‚ï¼š`cloudrun-express`ï¼‰
6. é€‰æ‹©è¿è¡Œæ—¶ï¼š**Node.js 18.x**ï¼ˆæˆ–å…¶ä»–æ”¯æŒçš„ç‰ˆæœ¬ï¼‰
7. æäº¤æ–¹æ³•é€‰æ‹©ï¼š**æœ¬åœ°ä¸Šä¼ æ–‡ä»¶å¤¹**
8. å‡½æ•°ä»£ç é€‰æ‹© `cloudrun-express` ç›®å½•è¿›è¡Œä¸Šä¼ 
9. **è‡ªåŠ¨å®‰è£…ä¾èµ–**ï¼šå¼€å¯æ­¤é€‰é¡¹
10. ç‚¹å‡»ã€Œåˆ›å»ºã€æŒ‰é’®ç­‰å¾…éƒ¨ç½²å®Œæˆ

### é€šè¿‡ CLI éƒ¨ç½²(æ•¬è¯·æœŸå¾…)

### æ‰“åŒ…éƒ¨ç½²

å¦‚æœéœ€è¦æ‰‹åŠ¨æ‰“åŒ…ï¼š

```bash
# åˆ›å»ºéƒ¨ç½²åŒ…ï¼ˆæ’é™¤äº‘æ‰˜ç®¡ç›¸å…³æ–‡ä»¶ï¼‰
zip -r cloudrun-express.zip . -x "node_modules/*" ".git/*" "*.log" "Dockerfile" ".dockerignore"
```

## è®¿é—®åº”ç”¨

### è·å–è®¿é—®åœ°å€

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨å¯ä»¥å‚è€ƒ[é€šè¿‡ HTTP è®¿é—®äº‘å‡½æ•°](https://docs.cloudbase.net/service/access-cloud-function)è®¾ç½®è‡ªå®šä¹‰åŸŸåè®¿é—® HTTP äº‘å‡½æ•°ã€‚

è®¿é—®åœ°å€æ ¼å¼ï¼š`https://your-function-url/`

### æµ‹è¯•æ¥å£

- **æ ¹è·¯å¾„**ï¼š`/` - Express æ¬¢è¿é¡µé¢
- **å¥åº·æ£€æŸ¥**ï¼š`/health` - æŸ¥çœ‹åº”ç”¨çŠ¶æ€
- **ç”¨æˆ·åˆ—è¡¨**ï¼š`/api/users` - è·å–ç”¨æˆ·åˆ—è¡¨
- **ç”¨æˆ·è¯¦æƒ…**ï¼š`/api/users/1` - è·å–ç‰¹å®šç”¨æˆ·
- **åˆ›å»ºç”¨æˆ·**ï¼š`POST /api/users` - åˆ›å»ºæ–°ç”¨æˆ·

### ç¤ºä¾‹è¯·æ±‚

```bash
# å¥åº·æ£€æŸ¥
curl https://your-function-url/health

# è·å–ç”¨æˆ·åˆ—è¡¨
curl https://your-function-url/api/users

# åˆ›å»ºæ–°ç”¨æˆ·
curl -X POST https://your-function-url/api/users \
  -H "Content-Type: application/json" \
  -d '{"name":"æµ‹è¯•ç”¨æˆ·","email":"test@example.com"}'
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ HTTP äº‘å‡½æ•°å¿…é¡»ä½¿ç”¨ 9000 ç«¯å£ï¼Ÿ
A: CloudBase HTTP äº‘å‡½æ•°è¦æ±‚åº”ç”¨ç›‘å¬ 9000 ç«¯å£ï¼Œè¿™æ˜¯å¹³å°çš„æ ‡å‡†é…ç½®ã€‚é€šè¿‡åœ¨ `scf_bootstrap` ä¸­è®¾ç½® `PORT=9000` ç¯å¢ƒå˜é‡æ¥æ§åˆ¶ç«¯å£ã€‚

### Q: HTTP äº‘å‡½æ•°å¦‚ä½•å¤„ç†å†·å¯åŠ¨ï¼Ÿ
A: äº‘å‡½æ•°åœ¨æ²¡æœ‰è¯·æ±‚æ—¶ä¼šè‡ªåŠ¨ä¼‘çœ ï¼Œé¦–æ¬¡è¯·æ±‚æ—¶éœ€è¦å†·å¯åŠ¨ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å‡å°‘å†·å¯åŠ¨æ—¶é—´ï¼š
- å‡å°‘ä¾èµ–åŒ…å¤§å°
- ä½¿ç”¨ç¯å¢ƒå˜é‡ç¼“å­˜é…ç½®
- é¿å…åœ¨å‡½æ•°ä¸­è¿›è¡Œé‡å¤çš„åˆå§‹åŒ–æ“ä½œ
- åˆç†è®¾ç½®å†…å­˜é…ç½®

### Q: scf_bootstrap æ–‡ä»¶æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ
A: `scf_bootstrap` æ˜¯äº‘å‡½æ•°çš„å¯åŠ¨è„šæœ¬ï¼Œç”¨äºï¼š
- è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¦‚ PORT=9000ï¼‰
- å¯åŠ¨åº”ç”¨ç¨‹åº
- é…ç½®è¿è¡Œæ—¶ç¯å¢ƒ

### Q: å¦‚ä½•æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—ï¼Ÿ
A: åœ¨ CloudBase æ§åˆ¶å°çš„äº‘å‡½æ•°é¡µé¢ï¼Œç‚¹å‡»å‡½æ•°åç§°è¿›å…¥è¯¦æƒ…é¡µæŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚

### Q: äº‘å‡½æ•°æ”¯æŒå“ªäº› Node.js ç‰ˆæœ¬ï¼Ÿ
A: CloudBase æ”¯æŒ Node.js 16.xã€18.xã€20.x ç­‰ç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨æœ€æ–°çš„ LTS ç‰ˆæœ¬ã€‚

### Q: å¦‚ä½•å¤„ç†é™æ€æ–‡ä»¶ï¼Ÿ
A: Express çš„é™æ€æ–‡ä»¶ä¸­é—´ä»¶ä¼šè‡ªåŠ¨å¤„ç† `public` ç›®å½•ä¸‹çš„é™æ€èµ„æºã€‚äº‘å‡½æ•°ç¯å¢ƒæ”¯æŒé™æ€æ–‡ä»¶æœåŠ¡ã€‚

### Q: äº‘å‡½æ•°æœ‰å“ªäº›é™åˆ¶ï¼Ÿ
A: 
- å•æ¬¡æ‰§è¡Œæ—¶é—´é™åˆ¶ï¼ˆé€šå¸¸ä¸º 900 ç§’ï¼‰
- å†…å­˜é™åˆ¶ï¼ˆ128MB - 3008MBï¼‰
- ä¸´æ—¶ç£ç›˜ç©ºé—´é™åˆ¶ï¼ˆ512MBï¼‰
- å¹¶å‘è¯·æ±‚é™åˆ¶

## æœ€ä½³å®è·µ

### 1. ç¯å¢ƒå˜é‡ç®¡ç†

åœ¨ `app.js` ä¸­æ·»åŠ ç¯å¢ƒå˜é‡æ”¯æŒï¼š

```javascript
// æ£€æµ‹äº‘å‡½æ•°ç¯å¢ƒ
const isCloudFunction = process.env.CLOUDBASE_FUNCTION;

// åŠ¨æ€ç«¯å£é…ç½®
const port = process.env.PORT || (isCloudFunction ? 9000 : 3000);
```

### 2. ä¼˜åŒ–å¯åŠ¨è„šæœ¬

å¢å¼º `scf_bootstrap` è„šæœ¬ï¼š

```bash
#!/bin/bash
export PORT=9000
export NODE_ENV=production
export TZ=Asia/Shanghai

# æ£€æŸ¥ä¾èµ–
if [ ! -d "node_modules" ]; then
    npm install --production
fi

# å¯åŠ¨åº”ç”¨
npm start
```

### 3. é”™è¯¯å¤„ç†

å®ç°äº‘å‡½æ•°ä¸“ç”¨çš„é”™è¯¯å¤„ç†ï¼š

```javascript
// äº‘å‡½æ•°é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  console.error('CloudFunction Error:', err.stack);
  
  res.status(err.status || 500).json({
    success: false,
    message: err.message,
    timestamp: new Date().toISOString(),
    requestId: req.headers['x-scf-request-id'] || 'unknown'
  });
});
```

### 4. å¥åº·æ£€æŸ¥ä¼˜åŒ–

å¢å¼ºå¥åº·æ£€æŸ¥æ¥å£ï¼š

```javascript
router.get('/', function(req, res, next) {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    framework: 'Express',
    deployment: 'HTTPäº‘å‡½æ•°',
    version: process.env.npm_package_version || '1.0.0',
    node_version: process.version,
    memory_usage: process.memoryUsage(),
    uptime: process.uptime()
  });
});
```

### 5. éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [ ] `scf_bootstrap` æ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ‰§è¡Œæƒé™
- [ ] ç«¯å£é…ç½®ä¸º 9000
- [ ] ä¾èµ–é¡¹åœ¨ `package.json` ä¸­æ­£ç¡®å£°æ˜
- [ ] æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆå¦‚ `Dockerfile`ã€`.dockerignore`ï¼‰
- [ ] æµ‹è¯•æœ¬åœ°å¯åŠ¨æ˜¯å¦æ­£å¸¸
- [ ] æ£€æŸ¥å¯åŠ¨è„šæœ¬è¯­æ³•æ˜¯å¦æ­£ç¡®
- [ ] éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
- [ ] ç¡®è®¤æ—¥å¿—è¾“å‡ºæ­£å¸¸

## æ€§èƒ½ä¼˜åŒ–

### 1. å‡å°‘å†·å¯åŠ¨æ—¶é—´

```javascript
// å…¨å±€å˜é‡ç¼“å­˜
let cachedConfig = null;

function getConfig() {
  if (!cachedConfig) {
    cachedConfig = {
      // é…ç½®é¡¹
    };
  }
  return cachedConfig;
}
```

### 2. ä¾èµ–ä¼˜åŒ–

```bash
# åªå®‰è£…ç”Ÿäº§ä¾èµ–
npm install --production

# æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶
npm prune
```

### 3. å†…å­˜ç®¡ç†

```javascript
// ç›‘æ§å†…å­˜ä½¿ç”¨
app.use((req, res, next) => {
  const memUsage = process.memoryUsage();
  console.log('Memory Usage:', {
    rss: Math.round(memUsage.rss / 1024 / 1024) + 'MB',
    heapUsed: Math.round(memUsage.heapUsed / 1024 / 1024) + 'MB'
  });
  next();
});
```

### 4. å“åº”ä¼˜åŒ–

```javascript
// å¯ç”¨ gzip å‹ç¼©
const compression = require('compression');
app.use(compression());

// è®¾ç½®ç¼“å­˜å¤´
app.use(express.static('public', {
  maxAge: '1d'
}));
```

---

## ç›¸å…³æ–‡æ¡£

- [è¿”å›ä¸»æ–‡æ¡£](../README.md)
- [äº‘æ‰˜ç®¡éƒ¨ç½²æŒ‡å—](./cloud-run.md)
- [CloudBase å®˜æ–¹æ–‡æ¡£](https://docs.cloudbase.net/)